{"version":3,"file":"runner.js","sourceRoot":"","sources":["../src/runner.ts"],"names":[],"mappings":"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","sourcesContent":["import * as vscode from \"vscode\";\r\nimport * as path from \"path\";\r\n\r\nconst outputChannel = vscode.window.createOutputChannel(\"Datascript\");\r\n\r\ntype EntryPointSource = \"configured\" | \"auto\";\r\n\r\ntype EntryPointCandidate = {\r\n  path: string;\r\n  source: EntryPointSource;\r\n};\r\n\r\nfunction normalize(p: string): string {\r\n  return path.normalize(p);\r\n}\r\n\r\nfunction addCandidate(\r\n  seen: Set<string>,\r\n  list: EntryPointCandidate[],\r\n  candidate: EntryPointCandidate,\r\n) {\r\n  const normalized = normalize(candidate.path);\r\n  if (!seen.has(normalized)) {\r\n    seen.add(normalized);\r\n    list.push(candidate);\r\n  }\r\n}\r\n\r\nasync function resolveEntryPoint(\r\n  document: vscode.TextDocument,\r\n  workspaceFolder: vscode.WorkspaceFolder | undefined,\r\n  config: vscode.WorkspaceConfiguration,\r\n): Promise<EntryPointCandidate | undefined> {\r\n  outputChannel.appendLine(\"[resolveEntryPoint] starting lookup\");\r\n\r\n  const explicitRoots = vscode.workspace.workspaceFolders?.map((folder) => folder.uri.fsPath) ?? [];\r\n  const workspaceRoot = workspaceFolder?.uri.fsPath ?? explicitRoots[0];\r\n  const configured = (config.get<string>(\"runtime.entryPoint\") ?? \"\").trim();\r\n  const candidates: EntryPointCandidate[] = [];\r\n  const seen = new Set<string>();\r\n\r\n  if (configured.length > 0) {\r\n    const absoluteCandidate = path.isAbsolute(configured)\r\n      ? configured\r\n      : workspaceRoot\r\n      ? path.join(workspaceRoot, configured)\r\n      : path.resolve(path.dirname(document.uri.fsPath), configured);\r\n    addCandidate(seen, candidates, { path: absoluteCandidate, source: \"configured\" });\r\n  }\r\n\r\n  if (workspaceRoot) {\r\n    addCandidate(seen, candidates, {\r\n      path: path.join(workspaceRoot, \"main.ts\"),\r\n      source: \"auto\",\r\n    });\r\n  }\r\n\r\n  for (const root of explicitRoots) {\r\n    addCandidate(seen, candidates, {\r\n      path: path.join(root, \"main.ts\"),\r\n      source: \"auto\",\r\n    });\r\n  }\r\n\r\n  let currentDir = path.dirname(document.uri.fsPath);\r\n  while (true) {\r\n    addCandidate(seen, candidates, {\r\n      path: path.join(currentDir, \"main.ts\"),\r\n      source: \"auto\",\r\n    });\r\n    const parent = path.dirname(currentDir);\r\n    if (parent === currentDir) {\r\n      break;\r\n    }\r\n    currentDir = parent;\r\n  }\r\n\r\n  for (const candidate of candidates) {\r\n    try {\r\n      await vscode.workspace.fs.stat(vscode.Uri.file(candidate.path));\r\n      outputChannel.appendLine(\r\n        `[resolveEntryPoint] using candidate ${candidate.path} (source=${candidate.source})`,\r\n      );\r\n      return candidate;\r\n    } catch (_error) {\r\n      // continue to next candidate\r\n    }\r\n  }\r\n\r\n  outputChannel.appendLine(\r\n    `[resolveEntryPoint] failed. configured='${configured}', workspaceRoot='${workspaceRoot ?? \"<none>\"}' candidates=${candidates\r\n      .map((c) => c.path)\r\n      .join(\"; \")}`,\r\n  );\r\n  return undefined;\r\n}\r\n\r\nasync function persistEntryPoint(\r\n  config: vscode.WorkspaceConfiguration,\r\n  workspaceFolder: vscode.WorkspaceFolder | undefined,\r\n  entryPoint: string,\r\n  alreadyConfigured: boolean,\r\n) {\r\n  if (alreadyConfigured) {\r\n    return;\r\n  }\r\n\r\n  const target = workspaceFolder\r\n    ? vscode.ConfigurationTarget.WorkspaceFolder\r\n    : vscode.ConfigurationTarget.Workspace;\r\n  const root = workspaceFolder?.uri.fsPath;\r\n  const valueToStore = root ? path.relative(root, entryPoint) : entryPoint;\r\n\r\n  await config.update(\"runtime.entryPoint\", valueToStore, target);\r\n}\r\n\r\nfunction buildCommand(\r\n  document: vscode.TextDocument,\r\n  config: vscode.WorkspaceConfiguration,\r\n  entryPoint: string,\r\n) {\r\n  const denoPath = (config.get<string>(\"runtime.denoPath\") ?? \"deno\").trim() || \"deno\";\r\n  const args = [\"run\", \"-A\", entryPoint, document.uri.fsPath];\r\n  return { command: denoPath, args };\r\n}\r\n\r\nasync function promptForEntryPoint(\r\n  workspaceFolder: vscode.WorkspaceFolder | undefined,\r\n  config: vscode.WorkspaceConfiguration,\r\n): Promise<string | undefined> {\r\n  const selection = await vscode.window.showOpenDialog({\r\n    canSelectMany: false,\r\n    openLabel: \"Select Datascript entry point\",\r\n    defaultUri: workspaceFolder?.uri,\r\n    filters: { TypeScript: [\"ts\"] },\r\n  });\r\n\r\n  if (!selection || selection.length === 0) {\r\n    return undefined;\r\n  }\r\n\r\n  const chosen = selection[0].fsPath;\r\n  const root = workspaceFolder?.uri.fsPath;\r\n\r\n  const target = workspaceFolder\r\n    ? vscode.ConfigurationTarget.WorkspaceFolder\r\n    : vscode.ConfigurationTarget.Workspace;\r\n\r\n  const valueToStore = root ? path.relative(root, chosen) : chosen;\r\n  await config.update(\"runtime.entryPoint\", valueToStore, target);\r\n\r\n  return chosen;\r\n}\r\n\r\nfunction quote(arg: string): string {\r\n  if (!/\\s/.test(arg) && !arg.includes(\"\\\"\")) {\r\n    return arg;\r\n  }\r\n\r\n  return `\"${arg.replace(/([\"\\\\])/g, \"\\\\$1\")}\"`;\r\n}\r\n\r\nexport function registerRunner(context: vscode.ExtensionContext) {\r\n  const runCommand = vscode.commands.registerCommand(\"datascript.runFile\", async () => {\r\n    const editor = vscode.window.activeTextEditor;\r\n\r\n    if (!editor || editor.document.languageId !== \"datascript\") {\r\n      vscode.window.showInformationMessage(\"Open a Datascript (.ds) file to run it.\");\r\n      return;\r\n    }\r\n\r\n    const document = editor.document;\r\n    const workspaceFolder = vscode.workspace.getWorkspaceFolder(document.uri);\r\n    const config = vscode.workspace.getConfiguration(\"datascript\", document.uri);\r\n    const resolved = await resolveEntryPoint(document, workspaceFolder, config);\r\n\r\n    let entryPoint = resolved?.path;\r\n\r\n    if (!entryPoint) {\r\n      entryPoint = await promptForEntryPoint(workspaceFolder, config);\r\n    }\r\n\r\n    if (!entryPoint) {\r\n      vscode.window.showWarningMessage(\r\n        \"Datascript entry point is not configured. Run command cancelled.\",\r\n      );\r\n      outputChannel.show(true);\r\n      return;\r\n    }\r\n\r\n    await persistEntryPoint(config, workspaceFolder, entryPoint, resolved?.source === \"configured\");\r\n\r\n    const { command, args } = buildCommand(document, config, entryPoint);\r\n\r\n    const terminalName = \"Datascript\";\r\n    const existing = vscode.window.terminals.find((term) => term.name === terminalName);\r\n    const terminal = existing ?? vscode.window.createTerminal(terminalName);\r\n    terminal.show(true);\r\n\r\n    const workspaceRoot = workspaceFolder?.uri.fsPath;\r\n    const cwd = workspaceRoot ?? path.dirname(document.uri.fsPath);\r\n    const cdCommand = `cd ${quote(cwd)}`;\r\n    terminal.sendText(cdCommand, true);\r\n\r\n    const runCommandText = `${quote(command)} ${args.map(quote).join(\" \")}`;\r\n    terminal.sendText(runCommandText, true);\r\n  });\r\n\r\n  context.subscriptions.push(runCommand);\r\n}\r\n"]}